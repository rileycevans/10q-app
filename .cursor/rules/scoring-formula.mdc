---
description: "Implement scoring formula once in contracts; enforce exact math, rounding, and invariants."
---

# Scoring Formula & Bonus Calculation

## Context

- Apply when implementing scoring logic, bonus calculations, or score validation.
- Ensures consistent scoring across all implementations.
- Prevents scoring drift and calculation errors.

## Requirements

### Constants Location

- Define all scoring constants in `packages/contracts/scoring.ts`:
  - `QUESTION_TIME_LIMIT_MS = 16000`
  - `BONUS_WINDOW_MS = 10000`
  - `BASE_POINTS_CORRECT = 5`
  - `BASE_POINTS_INCORRECT = 0`
  - `MAX_BONUS_POINTS = 5`
  - `SCORING_VERSION = 1`
- Never scatter magic numbers; import from contracts only.

### Scoring Implementation

- Implement scoring formula once in `packages/contracts/scoring.ts`.
- Edge Functions and tests must import and reuse this implementation.
- No duplicated formulas allowed.

### Base Points Formula

- `base_points = 5` if `is_correct = true` else `0`.
- Base points are integer values only.

### Bonus Points Formula

- Bonus uses step-based tiers from 0–10 seconds, 0 after 10 seconds.
- Step-based bonus tiers:
  - 0–2s: 5 bonus points
  - 2–4s: 4 bonus points
  - 4–6s: 3 bonus points
  - 6–8s: 2 bonus points
  - 8–10s: 1 bonus point
  - 10s+: 0 bonus points
- `clamped_time_ms = min(max(elapsed_ms, 0), BONUS_WINDOW_MS)`.
- Convert to seconds: `elapsed_seconds = clamped_time_ms / 1000`.
- Bonus is an integer value (no rounding needed).
- Final bonus must be in set: `{0, 1, 2, 3, 4, 5}`.

### Timeout Behavior

- If question expired (no answer within 16s):
  - `is_correct = false`.
  - `base_points = 0`.
  - `bonus_points = 0`.
  - `elapsed_ms = 16000`.

### Score Invariants

- Max score validation: `total_score <= 10 * (BASE_POINTS_CORRECT + MAX_BONUS_POINTS)`.
- Reject any score calculation that violates this constraint.
- Scoring must be deterministic: same inputs → same outputs.
- Include `scoring_version` in all score calculations for future migrations.

### Per-Question Score

- `question_score = base_points + bonus_points`.
- Store both values separately in `attempt_answers` table.
- Total score = sum of all question scores.

## Examples

<example>
  Valid implementation:
  ```typescript
  // packages/contracts/scoring.ts
  export function calculateBonus(elapsed_ms: number): number {
    const clamped = Math.min(Math.max(elapsed_ms, 0), BONUS_WINDOW_MS);
    const elapsedSeconds = clamped / 1000;
    
    if (elapsedSeconds < 2) return 5;
    else if (elapsedSeconds < 4) return 4;
    else if (elapsedSeconds < 6) return 3;
    else if (elapsedSeconds < 8) return 2;
    else if (elapsedSeconds < 10) return 1;
    else return 0;
  }
  ```
  - Edge Function imports and uses this function
  - Tests use same function for assertions
</example>

<example type="invalid">
  Invalid implementation:
  - Edge Function implements its own bonus calculation
  - Different rounding logic in tests vs production
  - Magic numbers like `10000` or `5` scattered in code
  - Bonus calculated as float without rounding
  - Score validation missing or inconsistent
</example>
